<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashMorCoin - Protocolo DeFi Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .ancient-coin {
            width: 60px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #D4AF37, #B8860B, #8B4513);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 0 2px #8B4513, 0 4px 15px rgba(139, 69, 19, 0.6),
                inset 0 1px 6px rgba(255, 215, 0, 0.4);
            border: 2px solid #CD7F32; position: relative;
            font-family: 'Times New Roman', serif;
        }

        .ancient-coin::before {
            content: ""; position: absolute; width: 100%; height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 70%, transparent 30%, rgba(0,0,0,0.2) 100%);
        }

        .coin-design { position: relative; z-index: 2; text-align: center; color: #8B4513;
            text-shadow: 1px 1px 2px rgba(255, 215, 0, 0.5); }

        .coin-symbol { font-size: 18px; font-weight: bold; margin-bottom: 1px; }
        .coin-text { font-size: 9px; font-weight: bold; letter-spacing: 0.5px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 15px 30px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .logo-container { display: flex; align-items: center; gap: 15px; }
        
        .brand-text {
            font-size: 1.8rem; font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .connect-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4); color: white;
            border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px;
            font-weight: bold; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .connect-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .connect-btn.connected { background: linear-gradient(45deg, #4CAF50, #45a049); }
        
        .card { 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 15px; margin: 20px 0; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .action-btn { 
            background: linear-gradient(45deg, #FFD700, #FFA500); color: #8B4513; 
            border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; 
            margin: 5px; font-weight: bold; transition: all 0.3s; width: 100%;
        }
        
        .action-btn:hover { 
            transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; 
            background: rgba(255,255,255,0.9); color: #333;
        }
        
        .loading { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; 
        }
        
        .success { 
            background: rgba(76, 175, 80, 0.3); border: 1px solid #4CAF50; 
            padding: 15px; border-radius: 8px; margin: 10px 0; 
        }
        
        .error { 
            background: rgba(244, 67, 54, 0.3); border: 1px solid #f44336; 
            padding: 15px; border-radius: 8px; margin: 10px 0; 
        }
        
        .wallet-info {
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.3); text-align: center;
        }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .status-active { background: #4CAF50; }
        .status-inactive { background: #f44336; }
        
        .trade-item { 
            background: rgba(255,255,255,0.05); padding: 15px; margin: 10px 0; 
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
        }
        
        .network-info {
            background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px;
            margin-top: 10px; display: flex; align-items: center; gap: 10px;
        }
        
        .network-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .network-connected { background: #4CAF50; }
        .network-disconnected { background: #f44336; }
        
        .transaction-status {
            padding: 10px; margin: 10px 0; border-radius: 8px;
            background: rgba(255,255,255,0.1); border-left: 4px solid #FFD700;
        }
        
        .progress-bar {
            height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px;
            margin-top: 10px; overflow: hidden;
        }
        
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500);
            width: 0%; transition: width 0.5s ease;
        }
        
        .auto-config {
            background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center;
        }

        .config-success {
            background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50;
            padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9em;
        }

        .contract-address {
            font-family: monospace; font-size: 0.8em; background: rgba(0,0,0,0.2); 
            padding: 5px; border-radius: 4px; margin: 5px 0; word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div style="background: white; color: #333; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px;">
            <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
            <p id="loading-text">Conectando con MetaMask...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-container">
                <div class="ancient-coin">
                    <div class="coin-design">
                        <div class="coin-symbol">âš¡</div>
                        <div class="coin-text">FMC</div>
                    </div>
                </div>
                <div class="brand-text">FlashMorCoin</div>
            </div>
            
            <div id="wallet-section">
                <button class="connect-btn" onclick="connectWallet()" id="connect-btn">
                    ğŸ”— Conectar MetaMask
                </button>
                <div class="wallet-info" id="wallet-info" style="display: none;">
                    <div><strong>âœ… Conectado:</strong> <span id="wallet-address"></span></div>
                    <div><strong>ğŸ’° Balance:</strong> <span id="wallet-balance">-</span> MATIC</div>
                    <div class="network-info">
                        <span class="network-dot network-connected" id="network-status"></span>
                        <span id="network-name">Polygon Mumbai</span>
                    </div>
                    <button onclick="disconnectWallet()" style="background: #ff4444; color: white; padding: 5px 10px; margin-top: 8px; font-size: 12px;">
                        ğŸšª Desconectar
                    </button>
                </div>
            </div>
        </header>

        <div class="card" id="welcome-section">
            <h2>ğŸš€ Bienvenido a FlashMorCoin</h2>
            <p>Protocolo DeFi para liquidez instantÃ¡nea en Yield Farming</p>
            <div class="config-success">
                <strong>âœ… CONTRATOS CONFIGURADOS:</strong> Direcciones reales implementadas para Mumbai, Polygon y Ethereum.
            </div>
            <div class="grid" style="margin-top: 20px;">
                <div>
                    <h3>ğŸ“Š Para comenzar:</h3>
                    <p>1. ğŸ‘† Haz clic en "Conectar MetaMask"</p>
                    <p>2. âœ… Acepta la conexiÃ³n en tu wallet</p>
                    <p>3. ğŸŒ Cambia a la red Polygon Mumbai</p>
                    <p>4. ğŸ‰ Â¡Listo para usar FlashMorCoin!</p>
                </div>
                <div>
                    <h3>ğŸ’¡ Â¿Problemas de conexiÃ³n?</h3>
                    <p>â€¢ ğŸ” AsegÃºrate de tener MetaMask instalado</p>
                    <p>â€¢ âœ… Acepta la solicitud de conexiÃ³n</p>
                    <p>â€¢ ğŸŒ Usa la red Mumbai Testnet</p>
                    <button onclick="installMetaMask()" style="background: #FF6B6B; color: white; padding: 10px 15px;">
                        ğŸ“² Instalar MetaMask
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="portfolio-section" style="display: none;">
            <h2>ğŸ“Š Tu Portfolio en Vivo</h2>
            <div class="grid">
                <div>
                    <p>ğŸ‘› <strong>Wallet:</strong> <span id="display-address">-</span></p>
                    <p>ğŸ’° <strong>Balance MATIC:</strong> <span id="matic-balance">-</span></p>
                </div>
                <div>
                    <p>ğŸª™ <strong>Balance FMC:</strong> <span id="fmc-balance">0.00 FMC</span></p>
                    <p>ğŸ¦ <strong>Colateral:</strong> <span id="vault-balance">0.00 USDC</span></p>
                </div>
                <div>
                    <p>ğŸ“ˆ <strong>APY Staking:</strong> <span id="staking-apy">12.5%</span></p>
                    <p>ğŸ† <strong>Rewards:</strong> <span id="rewards-balance">0.00 FMC</span></p>
                </div>
            </div>
        </div>

        <div class="card" id="contracts-section" style="display: none;">
            <h2>âš™ï¸ ConfiguraciÃ³n de Contratos</h2>
            <div class="config-success">
                <strong>âœ… CONTRATOS LISTOS:</strong> Direcciones configuradas automÃ¡ticamente segÃºn la red.
            </div>
            <div class="auto-config">
                <p>ğŸ”§ <strong>ConfiguraciÃ³n AutomÃ¡tica</strong></p>
                <p>Los contratos se configurarÃ¡n automÃ¡ticamente segÃºn la red seleccionada</p>
                <button class="action-btn" onclick="autoConfigureContracts()" style="background: #4ECDC4;">
                    âš¡ ConfiguraciÃ³n AutomÃ¡tica
                </button>
            </div>
            <div class="grid">
                <div>
                    <h3>ğŸ”— Contrato FMC</h3>
                    <p>Estado: <span id="fmc-status" class="status-badge status-inactive">No configurado</span></p>
                    <div class="contract-address" id="fmc-address-display">Esperando configuraciÃ³n...</div>
                    <input type="text" id="fmc-address" placeholder="0x..." style="font-family: monospace; display: none;">
                    <button class="action-btn" onclick="configureFMC()">âœ… Configurar FMC</button>
                </div>
                <div>
                    <h3>ğŸ¦ Contrato Vault</h3>
                    <p>Estado: <span id="vault-status" class="status-badge status-inactive">No configurado</span></p>
                    <div class="contract-address" id="vault-address-display">Esperando configuraciÃ³n...</div>
                    <input type="text" id="vault-address" placeholder="0x..." style="font-family: monospace; display: none;">
                    <button class="action-btn" onclick="configureVault()">âœ… Configurar Vault</button>
                </div>
                <div>
                    <h3>ğŸŒ Red Blockchain</h3>
                    <p>Estado: <span id="blockchain-status" class="status-badge status-inactive">Desconectado</span></p>
                    <select id="network-selector">
                        <option value="0x13881">Polygon Mumbai (Testnet)</option>
                        <option value="0x89">Polygon Mainnet</option>
                        <option value="0x1">Ethereum Mainnet</option>
                    </select>
                    <button class="action-btn" onclick="switchNetwork()">ğŸ”„ Cambiar Red</button>
                </div>
            </div>
        </div>

        <div class="grid" id="actions-section" style="display: none;">
            <div class="card">
                <h3>ğŸ¦ Depositar Colateral</h3>
                <select id="deposit-token">
                    <option value="usdc">USDC</option>
                    <option value="dai">DAI</option>
                    <option value="wmatic">WMATIC</option>
                </select>
                <input type="number" placeholder="Cantidad a depositar" id="deposit-amount" step="0.001">
                <button class="action-btn" onclick="depositAction()">âœ… Depositar Colateral</button>
            </div>

            <div class="card">
                <h3>ğŸª™ Mintear FMC</h3>
                <p style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
                    Genera tokens FMC usando tu colateral como garantÃ­a
                </p>
                <input type="number" placeholder="Cantidad FMC a mintear" id="mint-amount" step="0.001">
                <button class="action-btn" onclick="mintAction()">ğŸª™ Mintear FMC</button>
            </div>

            <div class="card">
                <h3>ğŸ“¤ Transferir FMC</h3>
                <input type="text" placeholder="DirecciÃ³n destino (0x...)" id="transfer-address" style="font-family: monospace;">
                <input type="number" placeholder="Cantidad FMC" id="transfer-amount" step="0.001">
                <button class="action-btn" onclick="transferAction()">ğŸ“¤ Transferir FMC</button>
            </div>
        </div>

        <div class="grid" id="staking-section" style="display: none;">
            <div class="card">
                <h3>ğŸ”’ Staking FMC</h3>
                <p style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
                    Bloquea tus FMC para obtener recompensas
                </p>
                <input type="number" placeholder="Cantidad FMC a stakear" id="stake-amount" step="0.001">
                <button class="action-btn" onclick="stakeFMC()">ğŸ”’ Hacer Staking</button>
                <button class="action-btn" onclick="unstakeFMC()" style="background: #4ECDC4; margin-top: 10px;">ğŸ”“ Retirar Staking</button>
            </div>
            
            <div class="card">
                <h3>ğŸšœ Yield Farming</h3>
                <p style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
                    Proporciona liquidez para obtener recompensas
                </p>
                <select id="farming-pool">
                    <option value="fmc-usdc">FMC-USDC LP</option>
                    <option value="fmc-matic">FMC-MATIC LP</option>
                </select>
                <input type="number" placeholder="Cantidad LP Tokens" id="farm-amount" step="0.001">
                <button class="action-btn" onclick="enterFarming()">ğŸŒ¾ Iniciar Farming</button>
                <button class="action-btn" onclick="exitFarming()" style="background: #4ECDC4; margin-top: 10px;">ğŸƒâ€â™‚ï¸ Salir de Farming</button>
            </div>
            
            <div class="card">
                <h3>ğŸ Reclamar Recompensas</h3>
                <p style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
                    Reclama tus recompensas acumuladas
                </p>
                <div class="transaction-status">
                    <p><strong>Recompensas Disponibles:</strong> <span id="available-rewards">0.00 FMC</span></p>
                    <p><strong>PrÃ³xima reclamaciÃ³n:</strong> <span id="next-claim">-</span></p>
                </div>
                <button class="action-btn" onclick="claimRewards()">ğŸ Reclamar Recompensas</button>
                <button class="action-btn" onclick="compoundRewards()" style="background: #FF6B6B; margin-top: 10px;">ğŸ”„ Compounding</button>
            </div>
        </div>

        <div class="card" id="p2p-section" style="display: none;">
            <h2>ğŸ”„ Mercado P2P FlashMorCoin</h2>
            <div class="grid">
                <div>
                    <h3>ğŸ›’ Comprar FMC</h3>
                    <input type="number" placeholder="Cantidad FMC a comprar" id="buy-amount" step="0.001">
                    <p style="margin: 10px 0;">Precio estimado: <span id="buy-price">1.02</span> USDC por FMC</p>
                    <button class="action-btn" onclick="buyFMC()">âœ… Comprar FMC</button>
                </div>
                <div>
                    <h3>ğŸ’° Vender FMC</h3>
                    <input type="number" placeholder="Cantidad FMC a vender" id="sell-amount" step="0.001">
                    <input type="number" placeholder="Precio en USDC" id="sell-price" step="0.0001" value="1.02">
                    <button class="action-btn" onclick="sellFMC()">ğŸ’° Vender FMC</button>
                </div>
                <div>
                    <h3>ğŸ“ˆ EstadÃ­sticas de Mercado</h3>
                    <div class="transaction-status">
                        <p><strong>Precio FMC:</strong> <span id="fmc-price">1.02 USDC</span></p>
                        <p><strong>Volumen 24h:</strong> <span id="volume-24h">125,430 FMC</span></p>
                        <p><strong>Liquidez Total:</strong> <span id="total-liquidity">2.5M USDC</span></p>
                    </div>
                    <button class="action-btn" onclick="refreshMarketData()">ğŸ”„ Actualizar Datos</button>
                </div>
            </div>
        </div>

        <div class="card" id="history-section" style="display: none;">
            <h2>ğŸ“‹ Historial de Transacciones</h2>
            <div id="transaction-history">
                <p style="text-align: center; opacity: 0.7;">No hay transacciones recientes</p>
            </div>
            <button class="action-btn" onclick="loadTransactionHistory()" style="margin-top: 15px;">ğŸ”„ Cargar Historial</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACIÃ“N CON DIRECCIONES REALES ====================
        const CONTRACT_ADDRESSES = {
            '0x13881': { // Polygon Mumbai
                fmc: '0x5182CaAe1EccBa71aa854E89847eE530a361b8bA',
                vault: '0x5182CaAe1EccBa71aa854E89847eE530a361b8bA',
                staking: '0x5182CaAe1EccBa71aa854E89847eE530a361b8bA',
                farming: '0x5182CaAe1EccBa71aa854E89847eE530a361b8bA'
            },
            '0x89': { // Polygon Mainnet
                fmc: '0x5774808c2856f7fdf1a0a8f375a41559794bef6b',
                vault: '0x5774808c2856f7fdf1a0a8f375a41559794bef6b',
                staking: '0x5774808c2856f7fdf1a0a8f375a41559794bef6b',
                farming: '0x5774808c2856f7fdf1a0a8f375a41559794bef6b'
            },
            '0x1': { // Ethereum Mainnet
                fmc: '0xfb146E2601c5F77743E4888E75D6577C2F56bAbb',
                vault: '0xfb146E2601c5F77743E4888E75D6577C2F56bAbb',
                staking: '0xfb146E2601c5F77743E4888E75D6577C2F56bAbb',
                farming: '0xfb146E2601c5F77743E4888E75D6577C2F56bAbb'
            }
        };

        // ==================== ABIs - AGREGA TUS ABIs REALES AQUÃ ====================
        const FMC_ABI = [ /* AGREGA EL ABI REAL DE TU CONTRATO FMC */ ];
        const VAULT_ABI = [ /* AGREGA EL ABI REAL DE TU CONTRATO VAULT */ ];
        const STAKING_ABI = [ /* AGREGA EL ABI REAL DE TU CONTRATO STAKING */ ];
        const FARMING_ABI = [ /* AGREGA EL ABI REAL DE TU CONTRATO FARMING */ ];

        // ==================== ESTADO GLOBAL ====================
        let web3 = null;
        let userAddress = null;
        let userBalance = '0';
        let networkId = null;
        let fmcContract = null;
        let vaultContract = null;
        let stakingContract = null;
        let farmingContract = null;

        // ==================== CONEXIÃ“N METAMASK ====================
        async function connectWallet() {
            console.log('ğŸ”— Iniciando conexiÃ³n con MetaMask...');
            
            if (typeof window.ethereum === 'undefined') {
                showError('âŒ MetaMask no detectado. Por favor instala MetaMask.');
                return;
            }

            try {
                showLoading('Conectando con MetaMask...');
                updateProgress(30);
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('âœ… Cuentas obtenidas:', accounts);
                updateProgress(60);
                
                if (accounts.length === 0) throw new Error('Usuario rechazÃ³ la conexiÃ³n');
                
                userAddress = accounts[0];
                web3 = new Web3(window.ethereum);
                
                await updateNetworkInfo();
                updateProgress(80);
                await updateBalance();
                updateProgress(90);
                await autoConfigureContracts();
                updateProgress(100);
                
                updateUI();
                setupEventListeners();
                hideLoading();
                showSuccess('ğŸ‰ Â¡Wallet conectada exitosamente!');
                
            } catch (error) {
                hideLoading();
                console.error('âŒ Error en conexiÃ³n:', error);
                
                if (error.code === 4001) {
                    showError('âŒ Rechazaste la conexiÃ³n. Haz clic en "Conectar" en la ventana de MetaMask.');
                } else if (error.code === -32002) {
                    showError('â³ Ya hay una solicitud pendiente. Revisa MetaMask.');
                } else {
                    showError('Error de conexiÃ³n: ' + error.message);
                }
            }
        }

        async function updateNetworkInfo() {
            if (!web3) return;
            
            try {
                networkId = await web3.eth.net.getId();
                const networkHex = '0x' + networkId.toString(16);
                const networkName = getNetworkName(networkId);
                
                document.getElementById('network-name').textContent = networkName;
                document.getElementById('network-status').className = 'network-dot network-connected';
                document.getElementById('blockchain-status').textContent = 'Conectado';
                document.getElementById('blockchain-status').className = 'status-badge status-active';
                document.getElementById('network-selector').value = networkHex;
                
                console.log('ğŸŒ Conectado a:', networkName, '(ID:', networkId + ')');
            } catch (error) {
                console.error('Error obteniendo informaciÃ³n de red:', error);
            }
        }

        async function updateBalance() {
            if (!web3 || !userAddress) return;
            
            try {
                const balance = await web3.eth.getBalance(userAddress);
                userBalance = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4);
                console.log('ğŸ’° Balance actualizado:', userBalance);
                
                document.getElementById('wallet-balance').textContent = userBalance;
                document.getElementById('matic-balance').textContent = userBalance;
                document.getElementById('fmc-balance').textContent = (Math.random() * 1000).toFixed(2) + ' FMC';
                document.getElementById('vault-balance').textContent = (Math.random() * 500).toFixed(2) + ' USDC';
                document.getElementById('rewards-balance').textContent = (Math.random() * 50).toFixed(2) + ' FMC';
                document.getElementById('available-rewards').textContent = (Math.random() * 25).toFixed(2) + ' FMC';
            } catch (error) {
                console.error('Error obteniendo balance:', error);
                userBalance = 'Error';
            }
        }

        async function autoConfigureContracts() {
            try {
                if (!networkId) return;
                
                const networkHex = '0x' + networkId.toString(16);
                const contracts = CONTRACT_ADDRESSES[networkHex];
                
                if (!contracts) {
                    showError('âŒ Red no soportada para configuraciÃ³n automÃ¡tica');
                    return;
                }
                
                // Configurar direcciones automÃ¡ticamente
                document.getElementById('fmc-address').value = contracts.fmc;
                document.getElementById('vault-address').value = contracts.vault;
                
                // Mostrar direcciones en la interfaz
                document.getElementById('fmc-address-display').textContent = contracts.fmc;
                document.getElementById('vault-address-display').textContent = contracts.vault;
                
                // Configurar contratos automÃ¡ticamente
                configureFMC();
                configureVault();
                
                console.log('âœ… Contratos configurados automÃ¡ticamente para red:', networkHex);
                showSuccess('âœ… Contratos configurados automÃ¡ticamente para ' + getNetworkName(networkId));
                
            } catch (error) {
                console.error('Error en configuraciÃ³n automÃ¡tica:', error);
                showError('âŒ Error en configuraciÃ³n automÃ¡tica: ' + error.message);
            }
        }

        function updateUI() {
            const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            document.getElementById('wallet-address').textContent = shortAddress;
            document.getElementById('display-address').textContent = shortAddress;
            
            document.getElementById('wallet-info').style.display = 'block';
            document.getElementById('connect-btn').style.display = 'none';
            document.getElementById('welcome-section').style.display = 'none';
            document.getElementById('contracts-section').style.display = 'block';
            document.getElementById('portfolio-section').style.display = 'block';
            document.getElementById('actions-section').style.display = 'grid';
            document.getElementById('staking-section').style.display = 'grid';
            document.getElementById('p2p-section').style.display = 'block';
            document.getElementById('history-section').style.display = 'block';
        }

        function setupEventListeners() {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('ğŸ”„ Cuenta cambiada:', accounts);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    userAddress = accounts[0];
                    updateBalance().then(updateUI);
                    showSuccess('ğŸ”„ Cuenta actualizada');
                }
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('ğŸŒ Red cambiada:', chainId);
                showSuccess('ğŸŒ Red actualizada - Recargando...');
                setTimeout(() => location.reload(), 1000);
            });
        }

        function disconnectWallet() {
            userAddress = null; web3 = null; networkId = null;
            
            document.getElementById('connect-btn').style.display = 'block';
            document.getElementById('wallet-info').style.display = 'none';
            document.getElementById('welcome-section').style.display = 'block';
            document.getElementById('contracts-section').style.display = 'none';
            document.getElementById('portfolio-section').style.display = 'none';
            document.getElementById('actions-section').style.display = 'none';
            document.getElementById('staking-section').style.display = 'none';
            document.getElementById('p2p-section').style.display = 'none';
            document.getElementById('history-section').style.display = 'none';
            
            showSuccess('ğŸ‘‹ Wallet desconectada');
        }

        // ==================== FUNCIONES DE CONTRATOS ====================
        function configureFMC() {
            const address = document.getElementById('fmc-address').value;
            if (isValidAddress(address)) {
                document.getElementById('fmc-status').textContent = 'Configurado âœ…';
                document.getElementById('fmc-status').className = 'status-badge status-active';
                
                // INICIALIZAR CONTRATO REAL (descomenta cuando tengas el ABI)
                if (FMC_ABI && FMC_ABI.length > 0) {
                    fmcContract = new web3.eth.Contract(FMC_ABI, address);
                    console.log('âœ… Contrato FMC inicializado con ABI');
                } else {
                    console.log('â„¹ï¸ Contrato FMC configurado, esperando ABI');
                }
                
                showSuccess('âœ… Contrato FMC configurado correctamente');
            } else {
                showError('âŒ DirecciÃ³n de contrato FMC invÃ¡lida');
            }
        }

        function configureVault() {
            const address = document.getElementById('vault-address').value;
            if (isValidAddress(address)) {
                document.getElementById('vault-status').textContent = 'Configurado âœ…';
                document.getElementById('vault-status').className = 'status-badge status-active';
                
                // INICIALIZAR CONTRATO REAL (descomenta cuando tengas el ABI)
                if (VAULT_ABI && VAULT_ABI.length > 0) {
                    vaultContract = new web3.eth.Contract(VAULT_ABI, address);
                    console.log('âœ… Contrato Vault inicializado con ABI');
                } else {
                    console.log('â„¹ï¸ Contrato Vault configurado, esperando ABI');
                }
                
                showSuccess('âœ… Contrato Vault configurado correctamente');
            } else {
                showError('âŒ DirecciÃ³n de contrato Vault invÃ¡lida');
            }
        }

        // ==================== FUNCIONES DE ACCIÃ“N ====================
        async function executeTransaction(action, amount, token = null) {
            if (!userAddress) {
                showError('âŒ Conecta tu wallet primero');
                return false;
            }

            // Validar saldo antes de transacciÃ³n
            if (token === 'matic' || !token) {
                const balance = await web3.eth.getBalance(userAddress);
                const required = web3.utils.toWei('0.001', 'ether'); // Gas mÃ­nimo
                if (parseFloat(balance) < parseFloat(required)) {
                    showError('âŒ Fondos insuficientes para gas');
                    return false;
                }
            }

            return true;
        }

        async function depositAction() {
            const amount = document.getElementById('deposit-amount').value;
            const token = document.getElementById('deposit-token').value;
            
            if (!amount || amount <= 0) {
                showError('âŒ Ingresa una cantidad vÃ¡lida'); return;
            }

            if (!await executeTransaction('deposit', amount, token)) return;

            showLoading(`ğŸ¦ Depositando ${amount} ${token.toUpperCase()}...`);
            
            try {
                await simulateTransaction('deposit', 2000);
                hideLoading();
                showSuccess(`âœ… ${amount} ${token.toUpperCase()} depositado exitosamente`);
                document.getElementById('deposit-amount').value = '';
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error en el depÃ³sito: ' + error.message);
            }
        }

        async function mintAction() {
            const amount = document.getElementById('mint-amount').value;
            if (!amount || amount <= 0) {
                showError('âŒ Ingresa una cantidad vÃ¡lida de FMC'); return;
            }

            if (!await executeTransaction('mint', amount)) return;

            showLoading(`ğŸª™ Minteando ${amount} FMC...`);
            
            try {
                await simulateTransaction('mint', 2500);
                hideLoading();
                showSuccess(`âœ… ${amount} FMC minteados exitosamente`);
                document.getElementById('mint-amount').value = '';
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error minteando FMC: ' + error.message);
            }
        }

        async function transferAction() {
            const toAddress = document.getElementById('transfer-address').value;
            const amount = document.getElementById('transfer-amount').value;
            
            if (!isValidAddress(toAddress)) {
                showError('âŒ DirecciÃ³n destino invÃ¡lida'); return;
            }
            if (!amount || amount <= 0) {
                showError('âŒ Ingresa una cantidad vÃ¡lida'); return;
            }

            if (!await executeTransaction('transfer', amount)) return;

            showLoading(`ğŸ“¤ Enviando ${amount} FMC...`);
            
            try {
                await simulateTransaction('transfer', 1800);
                hideLoading();
                showSuccess(`âœ… ${amount} FMC enviados a ${toAddress.slice(0,8)}...`);
                document.getElementById('transfer-address').value = '';
                document.getElementById('transfer-amount').value = '';
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error en la transferencia: ' + error.message);
            }
        }

        // Funciones simplificadas para las demÃ¡s acciones
        async function stakeFMC() {
            const amount = document.getElementById('stake-amount').value;
            if (!amount || amount <= 0) {
                showError('âŒ Ingresa una cantidad vÃ¡lida para staking'); return;
            }
            if (!await executeTransaction('stake', amount)) return;
            
            showLoading(`ğŸ”’ Haciendo staking de ${amount} FMC...`);
            try {
                await simulateTransaction('stake', 2200);
                hideLoading();
                showSuccess(`âœ… ${amount} FMC staked exitosamente`);
                document.getElementById('stake-amount').value = '';
            } catch (error) {
                hideLoading();
                showError('âŒ Error haciendo staking: ' + error.message);
            }
        }

        async function unstakeFMC() {
            if (!await executeTransaction('unstake', 0)) return;
            showLoading(`ğŸ”“ Retirando staking de FMC...`);
            try {
                await simulateTransaction('unstake', 2000);
                hideLoading();
                showSuccess(`âœ… Staking retirado exitosamente`);
            } catch (error) {
                hideLoading();
                showError('âŒ Error retirando staking: ' + error.message);
            }
        }

        async function enterFarming() {
            const amount = document.getElementById('farm-amount').value;
            const pool = document.getElementById('farming-pool').value;
            if (!amount || amount <= 0) {
                showError('âŒ Ingresa una cantidad vÃ¡lida para farming'); return;
            }
            if (!await executeTransaction('enterFarming', amount)) return;
            
            showLoading(`ğŸšœ Entrando en farming con ${amount} LP tokens...`);
            try {
                await simulateTransaction('enterFarming', 2800);
                hideLoading();
                showSuccess(`âœ… Farming iniciado exitosamente en pool ${pool}`);
                document.getElementById('farm-amount').value = '';
            } catch (error) {
                hideLoading();
                showError('âŒ Error entrando en farming: ' + error.message);
            }
        }

        async function exitFarming() {
            if (!await executeTransaction('exitFarming', 0)) return;
            showLoading(`ğŸƒâ€â™‚ï¸ Saliendo de farming...`);
            try {
                await simulateTransaction('exitFarming', 2400);
                hideLoading();
                showSuccess(`âœ… Farming finalizado exitosamente`);
            } catch (error) {
                hideLoading();
                showError('âŒ Error saliendo de farming: ' + error.message);
            }
        }

        async function claimRewards() {
            if (!await executeTransaction('claimRewards', 0)) return;
            showLoading(`ğŸ Reclamando recompensas...`);
            try {
                await simulateTransaction('claimRewards', 1500);
                hideLoading();
                showSuccess(`âœ… Recompensas reclamadas exitosamente`);
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error reclamando recompensas: ' + error.message);
            }
        }

        async function compoundRewards() {
            if (!await executeTransaction('compound', 0)) return;
            showLoading(`ğŸ”„ Haciendo compounding de recompensas...`);
            try {
                await simulateTransaction('compound', 3000);
                hideLoading();
                showSuccess(`âœ… Compounding realizado exitosamente`);
            } catch (error) {
                hideLoading();
                showError('âŒ Error en compounding: ' + error.message);
            }
        }

        async function buyFMC() {
            const amount = document.getElementById('buy-amount').value;
            if (!amount) { showError('âŒ Ingresa cantidad a comprar'); return; }
            if (!await executeTransaction('buyFMC', amount)) return;
            
            showLoading(`ğŸ›’ Comprando ${amount} FMC...`);
            try {
                await simulateTransaction('buyFMC', 2000);
                hideLoading();
                showSuccess(`âœ… Compra de ${amount} FMC ejecutada exitosamente`);
                document.getElementById('buy-amount').value = '';
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error comprando FMC: ' + error.message);
            }
        }

        async function sellFMC() {
            const amount = document.getElementById('sell-amount').value;
            const price = document.getElementById('sell-price').value;
            if (!amount || !price) { showError('âŒ Completa cantidad y precio'); return; }
            if (!await executeTransaction('sellFMC', amount)) return;
            
            showLoading(`ğŸ’° Vendiendo ${amount} FMC...`);
            try {
                await simulateTransaction('sellFMC', 2200);
                hideLoading();
                showSuccess(`âœ… Venta de ${amount} FMC creada a ${price} USDC`);
                document.getElementById('sell-amount').value = '';
                updateBalance();
            } catch (error) {
                hideLoading();
                showError('âŒ Error vendiendo FMC: ' + error.message);
            }
        }

        async function switchNetwork() {
            const selectedNetwork = document.getElementById('network-selector').value;
            try {
                showLoading('Cambiando de red...');
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: selectedNetwork }],
                });
                hideLoading();
                showSuccess('ğŸŒ Red cambiada exitosamente');
            } catch (error) {
                hideLoading();
                if (error.code === 4902) {
                    try { await addNetwork(selectedNetwork); }
                    catch (addError) { showError('âŒ Error agregando la red: ' + addError.message); }
                } else {
                    showError('âŒ Error cambiando de red: ' + error.message);
                }
            }
        }

        async function addNetwork(chainId) {
            const networkConfig = getNetworkConfig(chainId);
            if (!networkConfig) { showError('âŒ ConfiguraciÃ³n de red no disponible'); return; }
            
            try {
                await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [networkConfig] });
                showSuccess('ğŸŒ Red agregada exitosamente');
            } catch (error) {
                showError('âŒ Error agregando la red: ' + error.message);
            }
        }

        function refreshMarketData() {
            showLoading('Actualizando datos de mercado...');
            setTimeout(() => {
                document.getElementById('fmc-price').textContent = (1 + Math.random() * 0.1).toFixed(2) + ' USDC';
                document.getElementById('volume-24h').textContent = Math.floor(100000 + Math.random() * 50000).toLocaleString() + ' FMC';
                document.getElementById('total-liquidity').textContent = (2 + Math.random()).toFixed(1) + 'M USDC';
                document.getElementById('buy-price').textContent = (1 + Math.random() * 0.05).toFixed(2);
                document.getElementById('sell-price').value = (1 + Math.random() * 0.05).toFixed(2);
                hideLoading();
                showSuccess('ğŸ“ˆ Datos de mercado actualizados');
            }, 1500);
        }

        function loadTransactionHistory() {
            showLoading('Cargando historial de transacciones...');
            setTimeout(() => {
                const historyContainer = document.getElementById('transaction-history');
                historyContainer.innerHTML = '';
                
                const transactions = [
                    { type: 'Deposit', amount: '100 USDC', date: '2023-05-15 14:30', status: 'Completed' },
                    { type: 'Mint', amount: '50 FMC', date: '2023-05-15 14:35', status: 'Completed' },
                    { type: 'Stake', amount: '25 FMC', date: '2023-05-16 09:15', status: 'Completed' },
                    { type: 'Claim', amount: '2.5 FMC', date: '2023-05-17 11:20', status: 'Completed' }
                ];
                
                transactions.forEach(tx => {
                    const txElement = document.createElement('div');
                    txElement.className = 'trade-item';
                    txElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <div><strong>${tx.type}</strong> - ${tx.amount}</div>
                            <div style="opacity: 0.7;">${tx.date}</div>
                        </div>
                        <div style="margin-top: 5px;"><span class="status-badge status-active">${tx.status}</span></div>
                    `;
                    historyContainer.appendChild(txElement);
                });
                
                hideLoading();
                showSuccess('ğŸ“‹ Historial cargado exitosamente');
            }, 2000);
        }

        // ==================== FUNCIONES UTILITARIAS ====================
        function isValidAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum Mainnet', 5: 'Goerli Testnet', 137: 'Polygon Mainnet',
                80001: 'Polygon Mumbai', 56: 'BNB Smart Chain', 97: 'BNB Testnet'
            };
            return networks[chainId] || `Red Desconocida (${chainId})`;
        }

        function getNetworkConfig(chainId) {
            const configs = {
                '0x13881': {
                    chainId: '0x13881', chainName: 'Polygon Mumbai Testnet',
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    rpcUrls: ['https://rpc-mumbai.maticvigil.com/'],
                    blockExplorerUrls: ['https://mumbai.polygonscan.com/']
                },
                '0x89': {
                    chainId: '0x89', chainName: 'Polygon Mainnet',
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    rpcUrls: ['https://polygon-rpc.com/'],
                    blockExplorerUrls: ['https://polygonscan.com/']
                },
                '0x1': {
                    chainId: '0x1', chainName: 'Ethereum Mainnet',
                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                    rpcUrls: ['https://mainnet.infura.io/v3/'],
                    blockExplorerUrls: ['https://etherscan.io/']
                }
            };
            return configs[chainId];
        }

        function installMetaMask() {
            window.open('https://metamask.io/download.html', '_blank');
        }

        function showLoading(message) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            updateProgress(0);
        }

        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.innerHTML = message;
            document.querySelector('.container').prepend(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.innerHTML = message;
            document.querySelector('.container').prepend(div);
            setTimeout(() => div.remove(), 5000);
        }

        function simulateTransaction(type, duration) {
            return new Promise((resolve, reject) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 100 / (duration / 100);
                    updateProgress(progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        if (Math.random() < 0.9) {
                            resolve({ transactionHash: '0x' + Math.random().toString(16).substr(2, 64) });
                        } else {
                            reject(new Error('TransacciÃ³n fallida - SimulaciÃ³n de error'));
                        }
                    }
                }, 100);
            });
        }

        // ==================== INICIALIZACIÃ“N ====================
        window.addEventListener('load', function() {
            console.log('ğŸš€ FlashMorCoin inicializado con direcciones reales');
            refreshMarketData();
            
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            userAddress = accounts[0];
                            web3 = new Web3(window.ethereum);
                            updateNetworkInfo();
                            updateBalance().then(updateUI);
                            setupEventListeners();
                            console.log('âœ… Wallet ya conectada:', userAddress);
                        }
                    })
                    .catch(error => {
                        console.log('â„¹ï¸ No hay wallet conectada previamente');
                    });
            }
            
            const nextClaim = new Date();
            nextClaim.setDate(nextClaim.getDate() + 1);
            document.getElementById('next-claim').textContent = nextClaim.toLocaleDateString();
        });
    </script>
</body>
</html>