<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashMorCoin - Protocolo DeFi Automatizado</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .ancient-coin {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #D4AF37, #B8860B, #8B4513);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 0 2px #8B4513,
                0 4px 15px rgba(139, 69, 19, 0.6),
                inset 0 1px 6px rgba(255, 215, 0, 0.4);
            border: 2px solid #CD7F32;
            position: relative;
            font-family: 'Times New Roman', serif;
        }

        .ancient-coin::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 70%, transparent 30%, rgba(0,0,0,0.2) 100%);
        }

        .coin-design {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #8B4513;
            text-shadow: 1px 1px 2px rgba(255, 215, 0, 0.5);
        }

        .coin-symbol {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .coin-text {
            font-size: 9px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand-text {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .connect-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 15px; 
            margin: 20px 0; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .action-btn { 
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #8B4513; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold; 
            transition: all 0.3s;
            width: 100%;
        }
        
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .loading { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }
        
        .success { 
            background: rgba(76, 175, 80, 0.3); 
            border: 1px solid #4CAF50; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
        }
        
        .error { 
            background: rgba(244, 67, 54, 0.3); 
            border: 1px solid #f44336; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
        }
        
        .wallet-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            text-align: center;
        }
        
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            margin-left: 10px; 
        }
        
        .status-active { 
            background: #4CAF50; 
        }
        
        .status-inactive { 
            background: #f44336; 
        }
        
        .network-info {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .network-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .network-connected { background: #4CAF50; }
        .network-disconnected { background: #f44336; }
        
        .transaction-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #FFD700;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .auto-connect-notice {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .auto-refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1001;
        }
        
        .network-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .bsc-badge {
            background: linear-gradient(45deg, #F0B90B, #F8D33A);
            color: #000;
        }
        
        .polygon-badge {
            background: linear-gradient(45deg, #8247E5, #A16BF0);
        }
        
        .ethereum-badge {
            background: linear-gradient(45deg, #627EEA, #8A9EF5);
        }
        
        .node-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .node-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .node-online { background: #4CAF50; }
        .node-offline { background: #f44336; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div style="background: white; color: #333; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px;">
            <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
            <p id="loading-text">Conectando autom√°ticamente...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div id="auto-refresh-indicator" class="auto-refresh-indicator" style="display: none;">
        üîÑ Actualizando autom√°ticamente...
    </div>

    <div class="container">
        <header>
            <div class="logo-container">
                <div class="ancient-coin">
                    <div class="coin-design">
                        <div class="coin-symbol">‚ö°</div>
                        <div class="coin-text">FMC</div>
                    </div>
                </div>
                <div class="brand-text">FlashMorCoin</div>
                <div id="network-badge" class="network-badge" style="display: none;"></div>
            </div>
            
            <div id="wallet-section">
                <button class="connect-btn" onclick="connectWallet()" id="connect-btn">
                    üîó Conectar MetaMask
                </button>
                <div class="wallet-info" id="wallet-info" style="display: none;">
                    <div><strong>‚úÖ Wallet Conectada:</strong> <span id="wallet-address">0x3D114033Ed4C0BeAf9F554A5c84d7C5ca5b04765</span></div>
                    <div><strong>üí∞ Balance:</strong> <span id="wallet-balance">-</span> <span id="native-currency">ETH</span></div>
                    <div class="network-info">
                        <span class="network-dot network-connected" id="network-status"></span>
                        <span id="network-name">Conectando...</span>
                    </div>
                    <button onclick="disconnectWallet()" style="background: #ff4444; color: white; padding: 5px 10px; margin-top: 8px; font-size: 12px;">
                        üö™ Desconectar
                    </button>
                </div>
            </div>
        </header>

        <div class="card" id="welcome-section">
            <h2>üöÄ FlashMorCoin - Conectado a Infura & QuickNode</h2>
            <p>Protocolo DeFi completamente automatizado con infraestructura profesional</p>
            
            <div class="auto-connect-notice" id="auto-connect-notice">
                <p>ü§ñ <strong>SISTEMA PROFESIONAL ACTIVADO</strong></p>
                <p>üîó Conectado a: Infura + QuickNode</p>
                <p>üìç Wallet: 0x3D114033Ed4C0BeAf9F554A5c84d7C5ca5b04765</p>
            </div>
            
            <div class="grid" style="margin-top: 20px;">
                <div>
                    <h3>üéØ Infraestructura Profesional:</h3>
                    <p>‚Ä¢ üåê <strong>Infura ID:</strong> 4df8eead51294cd09eadf4b51efaa014</p>
                    <p>‚Ä¢ ‚ö° <strong>QuickNode:</strong> Polygon RPC & WebSocket</p>
                    <p>‚Ä¢ üîÑ <strong>Load Balancing:</strong> Autom√°tico entre nodos</p>
                    <p>‚Ä¢ üìä <strong>M√∫ltiples redes:</strong> Ethereum, Polygon, BSC</p>
                    <p>‚Ä¢ üöÄ <strong>Velocidad:</strong> Transacciones optimizadas</p>
                </div>
                <div>
                    <h3>üîß Estado de Nodos:</h3>
                    <div class="transaction-status">
                        <div class="node-status">
                            <span class="node-dot node-online"></span>
                            <span><strong>Infura Mainnet:</strong> ‚úÖ Conectado</span>
                        </div>
                        <div class="node-status">
                            <span class="node-dot node-online"></span>
                            <span><strong>QuickNode Polygon:</strong> ‚úÖ Conectado</span>
                        </div>
                        <div class="node-status">
                            <span class="node-dot node-online"></span>
                            <span><strong>QuickNode WebSocket:</strong> ‚úÖ Activo</span>
                        </div>
                        <div class="node-status">
                            <span class="node-dot node-online"></span>
                            <span><strong>Load Balancer:</strong> ‚úÖ Funcionando</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="testNodeConnections()" style="background: #4ECDC4; color: white; padding: 10px 15px; border: none; border-radius: 8px;">
                            üß™ Testear Conexiones
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Autom√°tico -->
        <div class="card" id="portfolio-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìä Portfolio Autom√°tico</h2>
                <div style="font-size: 0.8rem; opacity: 0.7;">
                    üîÑ Actualizado: <span id="last-update">-</span>
                    | üåê Nodo: <span id="current-node">Infura</span>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Balance Principal</div>
                    <div class="stat-value" id="native-balance">-</div>
                    <div class="stat-label" id="native-currency-2">ETH</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tokens FMC</div>
                    <div class="stat-value" id="fmc-balance">0.00</div>
                    <div class="stat-label">FMC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Colateral</div>
                    <div class="stat-value" id="vault-balance">0.00</div>
                    <div class="stat-label" id="stablecoin">USDC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rendimiento</div>
                    <div class="stat-value" id="staking-apy">12.5%</div>
                    <div class="stat-label">APY Auto</div>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n de Redes Profesional -->
        <div class="card" id="networks-section" style="display: none;">
            <h2>üåê Configuraci√≥n Profesional de Redes</h2>
            <div class="grid">
                <div>
                    <h3>üîó Proveedores RPC</h3>
                    <div class="transaction-status">
                        <p><strong>Infura Ethereum:</strong> 
                            <span class="status-badge status-active">ACTIVO</span>
                        </p>
                        <p><strong>QuickNode Polygon:</strong> 
                            <span class="status-badge status-active">ACTIVO</span>
                        </p>
                        <p><strong>WebSocket:</strong> 
                            <span class="status-badge status-active">CONECTADO</span>
                        </p>
                    </div>
                    <button class="action-btn" onclick="switchToInfura()" style="background: #627EEA;">
                        üü£ Usar Infura Ethereum
                    </button>
                    <button class="action-btn" onclick="switchToQuickNode()" style="background: #8247E5; margin-top: 5px;">
                        üü™ Usar QuickNode Polygon
                    </button>
                </div>
                <div>
                    <h3>üìä M√©tricas de Rendimiento</h3>
                    <div class="transaction-status">
                        <p><strong>Latencia Infura:</strong> <span id="infura-latency">- ms</span></p>
                        <p><strong>Latencia QuickNode:</strong> <span id="quicknode-latency">- ms</span></p>
                        <p><strong>√öltimo bloque:</strong> <span id="latest-block">-</span></p>
                        <p><strong>Gas Price:</strong> <span id="current-gas">- Gwei</span></p>
                    </div>
                    <button class="action-btn" onclick="updateNetworkMetrics()">
                        üìà Actualizar M√©tricas
                    </button>
                </div>
                <div>
                    <h3>‚ö° Configuraci√≥n Avanzada</h3>
                    <div class="transaction-status">
                        <p><strong>Wallet Activa:</strong> 0x3D1140...b04765</p>
                        <p><strong>Red Principal:</strong> <span id="main-network">Polygon</span></p>
                        <p><strong>Backup RPC:</strong> <span id="backup-rpc">Activado</span></p>
                    </div>
                    <button class="action-btn" onclick="optimizeNodeSelection()" style="background: #FF6B6B;">
                        üöÄ Optimizaci√≥n Autom√°tica
                    </button>
                </div>
            </div>
        </div>

        <!-- Contratos con m√∫ltiples redes -->
        <div class="card" id="contracts-section" style="display: none;">
            <h2>‚öôÔ∏è Contratos Multi-Red</h2>
            <div class="grid">
                <div>
                    <h3>üîó Contrato FMC</h3>
                    <p>Estado: <span id="fmc-status" class="status-badge status-active">‚úÖ Configurado</span></p>
                    <select id="fmc-network">
                        <option value="ethereum">Ethereum Mainnet</option>
                        <option value="polygon">Polygon Mainnet</option>
                        <option value="bsc">BSC Mainnet</option>
                    </select>
                    <input type="text" id="fmc-address" placeholder="0x..." style="font-family: monospace;">
                    <button class="action-btn" onclick="deployFMC()">üöÄ Desplegar Contrato</button>
                </div>
                <div>
                    <h3>üè¶ Contrato Vault</h3>
                    <p>Estado: <span id="vault-status" class="status-badge status-active">‚úÖ Configurado</span></p>
                    <select id="vault-network">
                        <option value="ethereum">Ethereum Mainnet</option>
                        <option value="polygon">Polygon Mainnet</option>
                        <option value="bsc">BSC Mainnet</option>
                    </select>
                    <input type="text" id="vault-address" placeholder="0x..." style="font-family: monospace;">
                    <button class="action-btn" onclick="deployVault()">üöÄ Desplegar Contrato</button>
                </div>
                <div>
                    <h3>üåê Gesti√≥n de Redes</h3>
                    <p>Estado: <span id="node-status" class="status-badge status-active">üü¢ √ìptimo</span></p>
                    <div class="transaction-status">
                        <p><strong>RPC Activo:</strong> <span id="active-rpc">QuickNode Polygon</span></p>
                        <p><strong>Wallet:</strong> 0x3D1140...b04765</p>
                        <p><strong>Balance RPC:</strong> <span id="rpc-balance">2 nodos activos</span></p>
                    </div>
                    <button class="action-btn" onclick="autoNodeFailover()" style="background: #4ECDC4;">
                        üîÑ Failover Autom√°tico
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel de Control Profesional -->
        <div class="card" id="control-panel" style="display: none;">
            <h2>üéõÔ∏è Panel de Control Profesional</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Infura Status</div>
                    <div class="stat-value">‚úÖ</div>
                    <div class="stat-label">4df8eead51294cd09eadf4b51efaa014</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">QuickNode Status</div>
                    <div class="stat-value">‚úÖ</div>
                    <div class="stat-label">Polygon RPC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">WebSocket</div>
                    <div class="stat-value">‚úÖ</div>
                    <div class="stat-label">Conectado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Transacciones</div>
                    <div class="stat-value" id="professional-tx-count">0</div>
                    <div class="stat-label">Hoy</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN PROFESIONAL ====================
        const CONFIG = {
            USER_WALLET: "0x3D114033Ed4C0BeAf9F554A5c84d7C5ca5b04765",
            INFURA_KEY: "4df8eead51294cd09eadf4b51efaa014",
            QUICKNODE_HTTP: "https://purple-bold-sunset.matic.quiknode.pro/6e2958c9720ad8d75f46b01d483e002df46d4524",
            QUICKNODE_WSS: "wss://purple-bold-sunset.matic.quiknode.pro/6e2958c9720ad8d75f46b01d483e002df46d4524",
            AUTO_REFRESH_INTERVAL: 30000,
            NETWORKS: {
                1: { 
                    name: 'Ethereum', 
                    currency: 'ETH', 
                    stablecoin: 'USDC', 
                    badge: 'ethereum-badge',
                    rpc: `https://mainnet.infura.io/v3/4df8eead51294cd09eadf4b51efaa014`
                },
                137: { 
                    name: 'Polygon', 
                    currency: 'MATIC', 
                    stablecoin: 'USDC', 
                    badge: 'polygon-badge',
                    rpc: 'https://purple-bold-sunset.matic.quiknode.pro/6e2958c9720ad8d75f46b01d483e002df46d4524'
                },
                56: { 
                    name: 'BSC', 
                    currency: 'BNB', 
                    stablecoin: 'BUSD', 
                    badge: 'bsc-badge',
                    rpc: 'https://bsc-dataseed.binance.org/'
                }
            }
        };

        // ==================== ESTADO GLOBAL PROFESIONAL ====================
        let web3 = null;
        let currentWeb3Provider = null;
        let userAddress = CONFIG.USER_WALLET;
        let currentNetwork = null;
        let autoRefreshInterval = null;
        let activeRPC = 'infura';

        // ==================== INICIALIZACI√ìN PROFESIONAL ====================
        async function initializeProfessionalApp() {
            console.log('üöÄ Iniciando FlashMorCoin - Modo Profesional');
            console.log('üìç Infura ID:', CONFIG.INFURA_KEY);
            console.log('üìç QuickNode:', CONFIG.QUICKNODE_HTTP);
            
            showLoading('Configurando infraestructura profesional...');
            updateProgress(10);

            // Paso 1: Configurar m√∫ltiples proveedores Web3
            await setupProfessionalWeb3();
            updateProgress(30);

            // Paso 2: Conectar a la red √≥ptima
            await connectToOptimalNetwork();
            updateProgress(50);

            // Paso 3: Cargar todos los datos
            await loadProfessionalData();
            updateProgress(70);

            // Paso 4: Configurar interfaz profesional
            setupProfessionalInterface();
            updateProgress(90);

            // Paso 5: Iniciar servicios profesionales
            startProfessionalServices();
            updateProgress(100);

            hideLoading();
            showSuccess('‚úÖ Sistema profesional activado con Infura & QuickNode');
        }

        async function setupProfessionalWeb3() {
            // Crear m√∫ltiples proveedores
            const infuraProvider = new Web3.providers.HttpProvider(
                `https://mainnet.infura.io/v3/${CONFIG.INFURA_KEY}`
            );
            
            const quicknodeProvider = new Web3.providers.HttpProvider(
                CONFIG.QUICKNODE_HTTP
            );

            // Probar proveedores y seleccionar el m√°s r√°pido
            const infuraLatency = await testProviderLatency(infuraProvider);
            const quicknodeLatency = await testProviderLatency(quicknodeProvider);

            // Seleccionar el proveedor m√°s r√°pido
            if (quicknodeLatency < infuraLatency) {
                web3 = new Web3(quicknodeProvider);
                currentWeb3Provider = 'quicknode';
                console.log('‚úÖ Usando QuickNode (m√°s r√°pido)');
            } else {
                web3 = new Web3(infuraProvider);
                currentWeb3Provider = 'infura';
                console.log('‚úÖ Usando Infura (m√°s r√°pido)');
            }

            updateProviderUI();
        }

        async function testProviderLatency(provider) {
            const testWeb3 = new Web3(provider);
            const start = Date.now();
            try {
                await testWeb3.eth.getBlockNumber();
                return Date.now() - start;
            } catch (error) {
                return Infinity;
            }
        }

        async function connectToOptimalNetwork() {
            try {
                // Detectar red actual
                const chainId = await web3.eth.getChainId();
                currentNetwork = CONFIG.NETWORKS[chainId] || CONFIG.NETWORKS[1];
                
                updateNetworkUI();
                updateProfessionalMetrics();
                
                console.log('üåê Red conectada:', currentNetwork.name);
                
            } catch (error) {
                console.error('Error conectando a red:', error);
                currentNetwork = CONFIG.NETWORKS[1]; // Ethereum por defecto
            }
        }

        async function loadProfessionalData() {
            await updateProfessionalBalance();
            await updateNodeMetrics();
            updateLastUpdateTime();
        }

        function setupProfessionalInterface() {
            updateUI();
            setupProfessionalEventListeners();
        }

        function startProfessionalServices() {
            // Auto-refresh profesional cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                autoRefreshProfessionalData();
            }, CONFIG.AUTO_REFRESH_INTERVAL);

            console.log('üîÑ Servicios profesionales iniciados');
        }

        // ==================== FUNCIONES PROFESIONALES ====================
        async function updateProfessionalBalance() {
            if (!web3) return;
            
            try {
                const balance = await web3.eth.getBalance(CONFIG.USER_WALLET);
                const formattedBalance = parseFloat(Web3.utils.fromWei(balance, 'ether')).toFixed(4);
                
                document.getElementById('wallet-balance').textContent = formattedBalance;
                document.getElementById('native-balance').textContent = formattedBalance;
                
            } catch (error) {
                console.error('Error actualizando balance profesional:', error);
                // Intentar con proveedor alternativo
                await switchToBackupProvider();
            }
        }

        async function updateNodeMetrics() {
            // Actualizar m√©tricas de rendimiento
            const infuraLatency = await testProviderLatency(
                new Web3.providers.HttpProvider(`https://mainnet.infura.io/v3/${CONFIG.INFURA_KEY}`)
            );
            const quicknodeLatency = await testProviderLatency(
                new Web3.providers.HttpProvider(CONFIG.QUICKNODE_HTTP)
            );

            document.getElementById('infura-latency').textContent = infuraLatency + ' ms';
            document.getElementById('quicknode-latency').textContent = quicknodeLatency + ' ms';

            // Actualizar √∫ltimo bloque
            try {
                const blockNumber = await web3.eth.getBlockNumber();
                document.getElementById('latest-block').textContent = '#' + blockNumber;
            } catch (error) {
                console.error('Error obteniendo bloque:', error);
            }
        }

        async function switchToBackupProvider() {
            console.log('üîÑ Cambiando a proveedor de backup...');
            
            if (currentWeb3Provider === 'infura') {
                // Cambiar a QuickNode
                web3 = new Web3(new Web3.providers.HttpProvider(CONFIG.QUICKNODE_HTTP));
                currentWeb3Provider = 'quicknode';
            } else {
                // Cambiar a Infura
                web3 = new Web3(new Web3.providers.HttpProvider(
                    `https://mainnet.infura.io/v3/${CONFIG.INFURA_KEY}`
                ));
                currentWeb3Provider = 'infura';
            }
            
            updateProviderUI();
            showSuccess('‚úÖ Proveedor cambiado a: ' + currentWeb3Provider.toUpperCase());
        }

        function updateProviderUI() {
            document.getElementById('current-node').textContent = 
                currentWeb3Provider === 'infura' ? 'Infura' : 'QuickNode';
            document.getElementById('active-rpc').textContent = 
                currentWeb3Provider === 'infura' ? 'Infura Ethereum' : 'QuickNode Polygon';
        }

        function updateProfessionalMetrics() {
            if (!currentNetwork) return;
            
            document.getElementById('network-name').textContent = currentNetwork.name;
            document.getElementById('native-currency').textContent = currentNetwork.currency;
            document.getElementById('native-currency-2').textContent = currentNetwork.currency;
            document.getElementById('stablecoin').textContent = currentNetwork.stablecoin;
            document.getElementById('main-network').textContent = currentNetwork.name;
            
            const networkBadge = document.getElementById('network-badge');
            networkBadge.textContent = currentNetwork.name;
            networkBadge.className = `network-badge ${currentNetwork.badge}`;
            networkBadge.style.display = 'block';
        }

        // ==================== SERVICIOS PROFESIONALES ====================
        async function autoRefreshProfessionalData() {
            showAutoRefreshIndicator();
            await updateProfessionalBalance();
            await updateNodeMetrics();
            updateLastUpdateTime();
            refreshProfessionalMarketData();
        }

        function showAutoRefreshIndicator() {
            const indicator = document.getElementById('auto-refresh-indicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // ==================== FUNCIONES DE INTERACCI√ìN ====================
        async function switchToInfura() {
            showLoading('Cambiando a Infura Ethereum...');
            web3 = new Web3(new Web3.providers.HttpProvider(
                `https://mainnet.infura.io/v3/${CONFIG.INFURA_KEY}`
            ));
            currentWeb3Provider = 'infura';
            await connectToOptimalNetwork();
            hideLoading();
            showSuccess('‚úÖ Conectado a Infura Ethereum');
        }

        async function switchToQuickNode() {
            showLoading('Cambiando a QuickNode Polygon...');
            web3 = new Web3(new Web3.providers.HttpProvider(CONFIG.QUICKNODE_HTTP));
            currentWeb3Provider = 'quicknode';
            await connectToOptimalNetwork();
            hideLoading();
            showSuccess('‚úÖ Conectado a QuickNode Polygon');
        }

        async function testNodeConnections() {
            showLoading('Probando conexiones de nodos...');
            
            const results = await Promise.allSettled([
                testProviderLatency(new Web3.providers.HttpProvider(
                    `https://mainnet.infura.io/v3/${CONFIG.INFURA_KEY}`
                )),
                testProviderLatency(new Web3.providers.HttpProvider(CONFIG.QUICKNODE_HTTP))
            ]);

            hideLoading();
            
            if (results[0].status === 'fulfilled' && results[1].status === 'fulfilled') {
                showSuccess(`‚úÖ Nodos funcionando - Infura: ${results[0].value}ms, QuickNode: ${results[1].value}ms`);
            } else {
                showError('‚ùå Algunos nodos no responden');
            }
        }

        // ==================== FUNCIONES UTILITARIAS ====================
        function showLoading(message) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            updateProgress(0);
        }

        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.innerHTML = message;
            document.querySelector('.container').prepend(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.innerHTML = message;
            document.querySelector('.container').prepend(div);
            setTimeout(() => div.remove(), 5000);
        }

        function setupProfessionalEventListeners() {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.on('chainChanged', (chainId) => {
                    showSuccess('üåê Red cambiada - Reconfigurando autom√°ticamente...');
                    setTimeout(() => {
                        connectToOptimalNetwork();
                        loadProfessionalData();
                    }, 1000);
                });
            }
        }

        function refreshProfessionalMarketData() {
            // Datos de mercado simulados
            document.getElementById('fmc-price').textContent = (1 + Math.random() * 0.1).toFixed(2) + ' ' + currentNetwork.stablecoin;
            document.getElementById('volume-24h').textContent = Math.floor(100000 + Math.random() * 50000).toLocaleString() + ' FMC';
            document.getElementById('total-liquidity').textContent = (2 + Math.random()).toFixed(1) + 'M ' + currentNetwork.stablecoin;
        }

        function updateUI() {
            document.getElementById('wallet-info').style.display = 'block';
            document.getElementById('connect-btn').style.display = 'none';
            document.getElementById('welcome-section').style.display = 'none';
            document.getElementById('portfolio-section').style.display = 'block';
            document.getElementById('networks-section').style.display = 'block';
            document.getElementById('contracts-section').style.display = 'block';
            document.getElementById('control-panel').style.display = 'block';
        }

        // ==================== INICIALIZACI√ìN ====================
        window.addEventListener('load', function() {
            console.log('üöÄ Inicializando FlashMorCoin Profesional...');
            setTimeout(() => {
                initializeProfessionalApp();
            }, 1000);
        });

        // Funciones de compatibilidad
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    showSuccess('‚úÖ Wallet conectada manualmente');
                } catch (error) {
                    showError('‚ùå Error conectando wallet: ' + error.message);
                }
            }
        }

        function disconnectWallet() {
            showSuccess('üëã Sistema desconectado - Recargando...');
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        // Funciones placeholder para botones
        function updateNetworkMetrics() {
            updateNodeMetrics();
            showSuccess('üìà M√©tricas de red actualizadas');
        }

        function optimizeNodeSelection() {
            showLoading('Optimizando selecci√≥n de nodos...');
            setTimeout(() => {
                switchToBackupProvider();
                hideLoading();
            }, 1500);
        }

        function autoNodeFailover() {
            showLoading('Ejecutando failover autom√°tico...');
            setTimeout(() => {
                switchToBackupProvider();
                hideLoading();
            }, 2000);
        }
    </script>
</body>
</html>